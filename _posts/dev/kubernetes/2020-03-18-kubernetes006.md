---
title: "KUB-24 #4 쿠버네티스 클러스터 직접 구성"
date: 2020-03-17 00:00:00 +0800
categories: kubernetes
tag: 
- container
- orchestration
- kubeadm
- kubespray
sidebar:
  title: "Development"
  nav: "dev-sidebar"
---
쿠버네티스를 직접 구성해야 할 때를 대비하여 직접 구성하는 방법을 알아보겠습니다. <br>

### 1. 대표적인 도구

#### 1.1 Kubeadm

- 쿠버네티스에서 공식 제공하는 클러스터 생성/관리 도구
- 여러 대의 마스터 노드 구성에 로드밸런서를 두는 구조

#### 1.2 Kubespray

- 상용 서비스에 적합한 보안성과 고가용성이 있는 오픈 소스 프로젝트
- 서버 환경 설정 자동화 도구인 앤서블 기반으로 개발
- ingress-nginx, helm, cephfs 등 추가 구성 요소를 클러스터에 실행하는 역할 수행

### 2. 실습 인프라 구성

#### 2.1 VM 생성

실습은 kubespray를 설치하는 것으로 하고 환경은 GCP로 하겠습니다.
Google Cloud Platform에 접속하여 VM 인스턴스 만들기를 클릭합니다. <br>

![KUB24001](/assets/images/kubenetes/KUB24001.png)

실습에서 Ubuntu 16.04 LTS를 사용 할 예정으로 부팅 디스크는 Ubuntu 16.04 LTS에 버전에 맞춰서 설정합니다 <br>

![KUB24001](/assets/images/kubenetes/KUB24002.png)

인스턴스 생성은 총 5개를 만듭니다.

![KUB24001](/assets/images/kubenetes/KUB24003.png)

*참고 사항** GCP는 최근에 서울 리전이 생겼는데 서울 리전을 선택해서 인스턴스를 만들었더니만 오류가 납니다. 
아직 안되나 봅니다.
{: .notice--primary}

#### 2.2 SSH 키 생성과 배포

instance-1 노드를 마스터노드#1로 정하고 해당 노드와 나머지 VM간 ssh 접근을 위해 설정을 수행합니다. <br>

먼저, 마스터 노드(instance-1)에 콘솔로 접속합니다. <br>
접속한 마스터 노드의 ssh 키를 생성합니다. <br>

![KUB24001](/assets/images/kubenetes/KUB24004.png)

생성된 마스터 노드의 ~/.ssh 디렉토리 안에 id_rsa.pub 파일을 복사하여 Compute Engine > 메타데이터 메뉴에 등록합니다. <br>

![KUB24001](/assets/images/kubenetes/KUB24005.png)

마스터 노드를 콘솔로 접속하여 SSH 원격 명령으로 호스트네임을 호출합니다. <br>
아래는 마스터 노드에서 instance-2 호스트네임을 호출하는 예입니다.

```sh 
***@instance-1:~$ ssh instance-2 hostname
The authenticity of host 'instance-2 (10.146.0.8)' can't be established.
ECDSA key fingerprint is SHA256:OOf45lb4eeddVTCwIh8RzdPYZ+V3OLaG2eF4Gm9f9S0.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'instance-2,10.146.0.8' (ECDSA) to the list of known hosts.
Permission denied (publickey).
```

### 3. Kubespray 설치

#### 3.1 필요 패키지 설치

먼저 ubuntu 패키지 매니저를 최신 상태로 업데이트 합니다. <br>

```sh 
sudo apt update
```

파이썬 패키지 매니저인 pip를 설치합니다. <br>
더불어, 설치 후에 버전을 확인합니다. <br>

```sh 
sudo apt -y install python-pip

pip --version
```

Kubespray를 git에서 clone 하기 위해 git을 설치합니다. <br>

```sh 
sudo apt -y install git
```

#### 3.2 kubespray 클론

kubespray를 git에서 클론합니다. <br>

```sh 
git clone https://github.com/kubernetes-sigs/kubespray.git
Cloning into 'kubespray'...
<중략...>
```

아래 명령으로 체크아웃을 합니다. <br>

```sh 
cd kubespray
git checkout -b v2.11.0
git status
```

git status 수행 결과가 On branch v2.11.0이면 의도했던 버전 지정이 완료 되었습니다. <br>

아래 명령으로 Kubespray에서 필요한 패키지를 설치합니다 <br>

```sh 
sudo pip install -r requirements.txt
```

**Warning Notice:** pip 수행 할 때 아래와 같은 문제 발생 할 수 있는데, 이 경우 locale 설정 문제로 
아래 해결책을 통해 해결합니.
{: .notice--warning}

```sh 
Summit@instance-1:~/kubespray$ sudo pip install -r requirements.txt 
Traceback (most recent call last):
  File "/usr/bin/pip", line 11, in <module>
    sys.exit(main())
  File "/usr/lib/python2.7/dist-packages/pip/__init__.py", line 215, in main
    locale.setlocale(locale.LC_ALL, '')
  File "/usr/lib/python2.7/locale.py", line 581, in setlocale
    return _setlocale(category, locale)
locale.Error: unsupported locale setting
```

***해결책*** <br>

- locale 파일 열기
- LC_ALL 설정 후 저장하기( :wq )

```sh
sudo vi /etc/default/locale

LC_ALL=en_US.UTF-8

sudo source /etc/default/locale
```

**Notice:** locale 설정 후에 적용이 안될 경우는 sudo reboot 수행 후에 
재시도해 봅니다.
{: .notice--info}

설치 후에 ansible 버전 확인하여 설치를 마무리 합니다. <br>

```sh 
ansible --version

ansible 2.7.16 ...<중략>...
```